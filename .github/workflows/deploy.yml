name: ğŸš€ Laravel Docker CI/CD (Build â†’ Test â†’ Deploy â†’ Verify)

on:
  push:
    branches: [ main ]

jobs:
  # 1ï¸âƒ£ BUILD AND TEST JOB
  build_and_test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: laravel_ecommerce
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: laravel_ecommerce
      DB_USERNAME: root
      DB_PASSWORD: root
      APP_ENV: testing
      APP_KEY: base64:temporaryKey=
      APP_URL: http://localhost

    steps:
      - name: ğŸ§­ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ§± Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, bcmath, mysql, zip, gd

      - name: ğŸ“¦ Install Composer Dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: ğŸ”§ Fix Permissions Pre-Build
        run: |
          sudo chown -R $USER:$USER storage bootstrap/cache || true
          sudo chmod -R 775 storage bootstrap/cache || true

      - name: â³ Wait for MySQL
        run: |
          echo "â³ Waiting for MySQL..."
          until mysqladmin ping -h127.0.0.1 -proot --silent; do
            sleep 3
          done
          echo "âœ… MySQL Ready!"

      - name: ğŸ”‘ Generate App Key
        run: php artisan key:generate --force

      - name: ğŸ“œ Run Migrations
        run: php artisan migrate --force

      - name: ğŸ§ª Run Laravel Tests
        run: php artisan test --env=testing

      - name: ğŸ³ Build Docker Image
        run: docker build -t laravel-app:latest .

      - name: âœ… Verify Container Startup
        run: |
          docker run -d --name laravel-test -p 9000:9000 laravel-app:latest
          sleep 10
          docker ps
          docker logs laravel-test

  # 2ï¸âƒ£ DEPLOY TO EC2
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_test
    if: success()

    steps:
      - name: ğŸš€ Deploy to AWS EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ§± Pulling latest code..."
            cd /var/www/${{ secrets.APP_DIR }}
            git pull origin main

            echo "ğŸ”§ Fixing ownership and permissions..."
            sudo chown -R www-data:www-data /var/www/${{ secrets.APP_DIR }}
            sudo find /var/www/${{ secrets.APP_DIR }} -type d -exec chmod 775 {} \;
            sudo find /var/www/${{ secrets.APP_DIR }} -type f -exec chmod 664 {} \;
            sudo chmod -R ug+rwx /var/www/${{ secrets.APP_DIR }}/storage /var/www/${{ secrets.APP_DIR }}/bootstrap/cache
            sudo find /var/www/${{ secrets.APP_DIR }} -type d -exec chmod g+s {} \;
            echo "ğŸ³ Rebuilding containers..."
            docker-compose down
            docker-compose up -d --build

            echo "âœ… Deployment complete."

  # 3ï¸âƒ£ POST-DEPLOY PERMISSION VERIFICATION
  verify:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: ğŸ” Verify Laravel Permissions on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ” Checking Laravel file and directory permissions..."

            cd /var/www/${{ secrets.APP_DIR }}

            echo "ğŸ“‚ Checking ownership (should be www-data):"
            sudo stat -c "%U:%G %n" storage bootstrap/cache | uniq

            echo "ğŸ“ Checking directory permissions (should be 775):"
            sudo find storage bootstrap/cache -type d -exec stat -c "%a %n" {} \; | grep -v "775" && echo "âš ï¸ Incorrect directory permissions found!" || echo "âœ… Directory permissions OK."

            echo "ğŸ“„ Checking file permissions (should be 664):"
            sudo find storage bootstrap/cache -type f -exec stat -c "%a %n" {} \; | grep -v "664" && echo "âš ï¸ Incorrect file permissions found!" || echo "âœ… File permissions OK."

            echo "ğŸ§¬ Checking group inheritance (setgid bit):"
            sudo find storage bootstrap/cache -maxdepth 1 -type d -printf "%M %n\n" | grep "s" && echo "âœ… Group inheritance enabled." || echo "âš ï¸ setgid bit missing on some directories."

            echo "âœ… Permission verification completed."
