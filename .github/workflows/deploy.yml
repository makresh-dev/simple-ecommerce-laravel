name: "üöÄ Laravel Docker CI/CD (Build ‚Üí Test ‚Üí Deploy ‚Üí Verify)"

on:
  push:
    branches: [ master ]

jobs:
  # 1Ô∏è‚É£ BUILD AND TEST JOB
  build_and_test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: laravel_ecommerce
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: laravel_ecommerce
      DB_USERNAME: root
      DB_PASSWORD: root
      APP_ENV: testing
      APP_URL: http://localhost

    steps:
      - name: üß≠ Checkout Code
        uses: actions/checkout@v4

      - name: üß± Setup PHP (for composer only)
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, bcmath, mysql, zip, gd

      - name: üì¶ Install Composer Dependencies (for CI with dev)
        run: composer install --no-interaction --prefer-dist --optimize-autoloader --dev

      - name: üîß Fix Permissions Pre-Build
        run: |
          sudo chown -R $USER:$USER storage bootstrap/cache || true
          sudo chmod -R 775 storage bootstrap/cache || true

      - name: ‚è≥ Wait for MySQL
        run: |
          echo "‚è≥ Waiting for MySQL..."
          until mysqladmin ping -h127.0.0.1 -proot --silent; do
            sleep 3
          done
          echo "‚úÖ MySQL Ready!"
      
      - name: üê≥ Build Laravel Docker Image (with dev packages)
        run: |
          docker build --build-arg COMPOSER_DEV=true --build-arg APP_ENV=production -t ${{ secrets.APP_DIR }} .

      - name: üê≥ Start Laravel Container
        run: |
          docker run -d --name laravel-app \
            -e APP_ENV=production \
            -e APP_DEBUG=false \
            -e DB_CONNECTION=mysql \
            -e DB_HOST=127.0.0.1 \
            -e DB_PORT=3306 \
            -e DB_DATABASE=laravel_ecommerce \
            -e DB_USERNAME=root \
            -e DB_PASSWORD=root \
            -p 9000:9000 ${{ secrets.APP_DIR }}
          sleep 15
          docker ps

      - name: üîë Generate App Key (inside container)
        run: docker exec laravel-app php artisan key:generate --force --env=production

      - name: üìú Run Migrations (inside container)
        run: docker exec laravel-app php artisan migrate --force --env=production

      - name: üß™ Run Tests (inside container)
        run: docker exec laravel-app php artisan test --env=testing

      - name: üßπ Cleanup Build Container
        run: |
          docker stop laravel-ap
