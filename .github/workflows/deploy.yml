name: "ğŸš€ Laravel Docker CI/CD (Build â†’ Test â†’ Deploy â†’ Verify)"

on:
  push:
    branches: [ master ]

jobs:
  # 1ï¸âƒ£ BUILD AND TEST JOB
  build_and_test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: laravel_ecommerce
        options: >-
          --health-cmd="mysqladmin ping -h localhost -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      DB_CONNECTION: mysql
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_DATABASE: laravel_ecommerce
      DB_USERNAME: root
      DB_PASSWORD: root
      APP_ENV: testing
      APP_URL: http://localhost

    steps:
      - name: ğŸ§­ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ§± Setup PHP (for composer only)
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, bcmath, mysql, zip, gd

      - name: ğŸ“¦ Install Composer Dependencies (with dev)
        run: composer update && composer install --dev

      - name: ğŸ”§ Fix Permissions Pre-Build
        run: |
          sudo chown -R $USER:$USER storage bootstrap/cache || true
          sudo chmod -R 775 storage bootstrap/cache || true

      - name: â³ Wait for MySQL
        run: |
          echo "â³ Waiting for MySQL..."
          until mysqladmin ping -h127.0.0.1 -proot --silent; do
            sleep 3
          done
          echo "âœ… MySQL Ready!"
      
      - name: ğŸ³ Build Laravel Docker Image
        run: |
          docker build -t ${{ secrets.APP_DIR }} .

      - name: ğŸ³ Start Laravel Container
        run: |
          docker run -d --name laravel-app \
            -e APP_ENV=production \
            -e APP_DEBUG=false \
            -e DB_CONNECTION=mysql \
            -e DB_HOST=127.0.0.1 \
            -e DB_PORT=3306 \
            -e DB_DATABASE=laravel_ecommerce \
            -e DB_USERNAME=root \
            -e DB_PASSWORD=root \
            -p 9000:9000 ${{ secrets.APP_DIR }}
          sleep 15
          docker ps

      - name: ğŸ”‘ Generate App Key (inside container)
        run: |
          docker exec laravel-app bash -c "APP_ENV=production php artisan key:generate --force"

      - name: ğŸ“œ Run Migrations (inside container)
        run: |
          docker exec laravel-app bash -c "APP_ENV=production php artisan migrate --force"

      - name: ğŸ§ª Run Tests (inside container)
        run: |
          docker exec laravel-app bash -c "APP_ENV=production php artisan test --env=testing"

      - name: ğŸ§¹ Cleanup Build Container
        run: |
          docker stop laravel-app || true
          docker rm laravel-app || true

  # 2ï¸âƒ£ DEPLOY TO EC2
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_test
    if: success()

    steps:
      - name: ğŸš€ Deploy to AWS EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ§± Pulling latest code..."
            cd /var/www/${{ secrets.APP_DIR }}
            git pull origin master

            echo "ğŸ”§ Fixing ownership and permissions..."
            sudo chown -R root:www-data /var/www/${{ secrets.APP_DIR }}
            sudo chmod 750 /var/www/${{ secrets.APP_DIR }}
            sudo find /var/www/${{ secrets.APP_DIR }} -type d -exec chmod 755 {} \;
            sudo find /var/www/${{ secrets.APP_DIR }} -type f -exec chmod 644 {} \;
            sudo chmod -R ug+rwx /var/www/${{ secrets.APP_DIR }}/storage /var/www/${{ secrets.APP_DIR }}/bootstrap/cache
            sudo find /var/www/${{ secrets.APP_DIR }} -type d -exec chmod g+s {} \;

            echo "ğŸ³ Rebuilding containers..."
            docker-compose down
            docker-compose up -d --build

            echo "âœ… Deployment complete."

  # 3ï¸âƒ£ POST-DEPLOY PERMISSION VERIFICATION
  verify:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: ğŸ” Verify Laravel Permissions on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ” Checking Laravel file and directory permissions..."
            cd /var/www/${{ secrets.APP_DIR }}

            echo "ğŸ“‚ Ownership check:"
            sudo stat -c "%U:%G %n" storage bootstrap/cache | uniq

            echo "ğŸ“ Directory permissions (expect 755):"
            sudo find storage bootstrap/cache -type d -exec stat -c "%a %n" {} \; | grep -v "755" && echo "âš ï¸ Incorrect directory permissions found!" || echo "âœ… Directory permissions OK."

            echo "ğŸ“„ File permissions (expect 644):"
            sudo find storage bootstrap/cache -type f -exec stat -c "%a %n" {} \; | grep -v "644" && echo "âš ï¸ Incorrect file permissions found!" || echo "âœ… File permissions OK."

            echo "ğŸ§¬ Checking group inheritance (setgid bit):"
            sudo find storage bootstrap/cache -maxdepth 1 -type d -printf "%M %n\n" | grep "s" && echo "âœ… Group inheritance enabled." || echo "âš ï¸ setgid bit missing on some directories."

            echo "âœ… Permission verification completed."
